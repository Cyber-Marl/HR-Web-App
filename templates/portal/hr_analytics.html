{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="page-header">
    <div class="container">
        <h1>HR Analytics</h1>
        <p>Insights and metrics at a glance.</p>
    </div>
</section>

<section class="section">
    <div class="container">
        <div class="analytics-back">
            <a href="{% url 'portal:hr_dashboard' %}" class="btn btn-outline"><i class="fas fa-arrow-left"></i> Back to
                Dashboard</a>
        </div>

        <!-- Stat Cards -->
        <div class="stat-cards-grid">
            <div class="analytics-stat-card purple">
                <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                <div class="stat-details">
                    <div class="stat-number">{{ total_applications }}</div>
                    <div class="stat-label">Total Applications</div>
                </div>
            </div>
            <div class="analytics-stat-card green">
                <div class="stat-icon"><i class="fas fa-briefcase"></i></div>
                <div class="stat-details">
                    <div class="stat-number">{{ open_positions }}</div>
                    <div class="stat-label">Open Positions</div>
                </div>
            </div>
            <div class="analytics-stat-card orange">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-details">
                    <div class="stat-number">{{ avg_time_to_hire }} days</div>
                    <div class="stat-label">Avg. Time to Hire</div>
                </div>
            </div>
            <div class="analytics-stat-card blue">
                <div class="stat-icon"><i class="fas fa-envelope"></i></div>
                <div class="stat-details">
                    <div class="stat-number">{{ subscriber_count }}</div>
                    <div class="stat-label">Newsletter Subscribers</div>
                </div>
            </div>
            <div class="analytics-stat-card teal">
                <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-details">
                    <div class="stat-number">{{ total_events }}</div>
                    <div class="stat-label">Active Events</div>
                </div>
            </div>
            <div class="analytics-stat-card pink">
                <div class="stat-icon"><i class="fas fa-clipboard-list"></i></div>
                <div class="stat-details">
                    <div class="stat-number">{{ onboarding_active }}</div>
                    <div class="stat-label">Active Onboardings</div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Hiring Funnel -->
            <div class="chart-card">
                <h3><i class="fas fa-filter"></i> Hiring Funnel</h3>
                <div class="chart-container">
                    <canvas id="funnelChart"></canvas>
                </div>
            </div>

            <!-- Applications Over Time -->
            <div class="chart-card">
                <h3><i class="fas fa-chart-line"></i> Applications Over Time</h3>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <!-- Top Jobs -->
            <div class="chart-card">
                <h3><i class="fas fa-chart-bar"></i> Top Jobs by Applications</h3>
                <div class="chart-container">
                    <canvas id="topJobsChart"></canvas>
                </div>
            </div>

            <!-- Event Registrations -->
            <div class="chart-card">
                <h3><i class="fas fa-calendar-alt"></i> Event Registrations</h3>
                <div class="chart-container">
                    <canvas id="eventsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .analytics-back {
        margin-bottom: 2rem;
    }

    .stat-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.25rem;
        margin-bottom: 2.5rem;
    }

    .analytics-stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
    }

    .analytics-stat-card:hover {
        transform: translateY(-3px);
    }

    .stat-icon {
        width: 55px;
        height: 55px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        color: white;
        flex-shrink: 0;
    }

    .analytics-stat-card.purple .stat-icon {
        background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .analytics-stat-card.green .stat-icon {
        background: linear-gradient(135deg, #11998e, #38ef7d);
    }

    .analytics-stat-card.orange .stat-icon {
        background: linear-gradient(135deg, #f093fb, #f5576c);
    }

    .analytics-stat-card.blue .stat-icon {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
    }

    .analytics-stat-card.teal .stat-icon {
        background: linear-gradient(135deg, #43e97b, #38f9d7);
    }

    .analytics-stat-card.pink .stat-icon {
        background: linear-gradient(135deg, #fa709a, #fee140);
    }

    .stat-details .stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
        line-height: 1.2;
    }

    .stat-details .stat-label {
        font-size: 0.85rem;
        color: #888;
        margin-top: 0.15rem;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }

    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .chart-card h3 {
        color: var(--primary);
        font-size: 1.1rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .chart-card h3 i {
        margin-right: 0.5rem;
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    @media (max-width: 968px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    // Color palette
    const colors = {
        primary: '#667eea',
        secondary: '#764ba2',
        success: '#28a745',
        warning: '#ffc107',
        danger: '#dc3545',
        info: '#17a2b8',
    };

    // ── Hiring Funnel (Donut Chart) ──
    const funnelCtx = document.getElementById('funnelChart').getContext('2d');
    new Chart(funnelCtx, {
        type: 'doughnut',
        data: {
            labels: ['Pending', 'Reviewed', 'Interview', 'Hired', 'Rejected'],
            datasets: [{
                data: [
                    {{ funnel.pending }},
            {{ funnel.reviewed }},
                {{ funnel.interview }},
        {{ funnel.hired }},
        {{ funnel.rejected }}
            ],
        backgroundColor: ['#ffc107', '#17a2b8', '#667eea', '#28a745', '#dc3545'],
        borderWidth: 0,
        hoverOffset: 8,
        }]
    },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' },
        },
        cutout: '60%',
    }
});

    // ── Applications Over Time (Line Chart) ──
    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    new Chart(timelineCtx, {
        type: 'line',
        data: {
            labels: [{% for item in timeline %}'{{ item.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Applications',
            data: [{% for item in timeline %}{{ item.count }}{% if not forloop.last %}, {% endif %} {% endfor %}],
    borderColor: colors.primary,
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
            fill: true,
                tension: 0.4,
                    pointBackgroundColor: colors.primary,
                        pointRadius: 5,
                            pointHoverRadius: 7,
        }]
    },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } },
        },
    }
});

    // ── Top Jobs (Horizontal Bar Chart) ──
    const topJobsCtx = document.getElementById('topJobsChart').getContext('2d');
    new Chart(topJobsCtx, {
        type: 'bar',
        data: {
            labels: [{% for item in top_jobs %}'{{ item.title|truncatewords:4 }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Applications',
            data: [{% for item in top_jobs %}{{ item.app_count }}{% if not forloop.last %}, {% endif %} {% endfor %}],
    backgroundColor: ['#667eea', '#764ba2', '#11998e', '#f5576c', '#4facfe'],
        borderRadius: 6,
        }]
    },
    options: {
        indexAxis: 'y',
            responsive: true,
                maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
        scales: {
            x: { beginAtZero: true, ticks: { stepSize: 1 } },
        },
    }
});

    // ── Event Registrations (Bar Chart) ──
    const eventsCtx = document.getElementById('eventsChart').getContext('2d');
    new Chart(eventsCtx, {
        type: 'bar',
        data: {
            labels: [{% for item in event_stats %}'{{ item.title|truncatewords:3 }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Registrations',
            data: [{% for item in event_stats %}{{ item.reg_count }}{% if not forloop.last %}, {% endif %} {% endfor %}],
    backgroundColor: ['#43e97b', '#38f9d7', '#4facfe', '#f093fb', '#fa709a'],
        borderRadius: 6,
        }]
    },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } },
        },
    }
});
</script>
{% endblock %}